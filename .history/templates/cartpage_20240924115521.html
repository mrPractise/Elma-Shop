{% load static %}
{% load humanize %}
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Cart</title>
    <style>
   .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

    </style>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />

  </head>
  <body>
    {% include 'navbar.html' %}
    <div class="cart-container">
      <div class="cart-items">
        <h1>Your Shopping Cart</h1>
        {% if cart_items %} {% for item in cart_items %}
        <div class="cart-item" data-product-id="{{ item.product.id }}">
          <div class="item-content">
            <img
              src="{{ item.product.image.url }}"
              alt="{{ item.product.name }}"
              class="item-image"
            />
            <div class="item-details">
              <div class="item-name">{{ item.product.name }}</div>
              <div class="item-price">Ksh.{{ item.product.price|intcomma }}</div>
              <div class="item-quantity">
                <button
                  class="quantity-btn"
                  data-product-id="{{ item.product.id }}"
                >
                  -
                </button>
                <span>{{ item.quantity }}</span>
                <button
                  class="quantity-btn"
                  data-product-id="{{ item.product.id }}"
                >
                  +
                </button>
              </div>
            </div>
            <div class="item-total">Ksh.{{ item.total_price|intcomma }}</div>
          </div>
        </div>
        {% endfor %} {% else %}
        <p class="empty-cart-message">
          Your cart is empty. Add some items to get started!
        </p>
        {% endif %}
      </div>

      <div class="cart-summary">
        <h2 class="summary-title">Order Summary</h2>
        {% if cart_items %}
        <div class="summary-items">
          {% for item in cart_items %}
          <div class="summary-item" data-product-id="{{ item.product.id }}">
            <div class="summary-item-details">
              <div class="summary-item-name">{{ item.product.name }}</div>
              <div class="summary-item-quantity">
                Quantity: {{ item.quantity }}
              </div>
            </div>
            <div class="summary-item-total">Ksh.{{ item.total_price|intcomma }}</div>
          </div>
          {% endfor %}
        </div>
        <div class="summary-subtotal summary-item">
          <span>Subtotal</span>
          <span>Ksh.{{ subtotal|intcomma }}</span>
        </div>
        <div class="summary-total">
          <span>Total</span>
          <span>Ksh.{{ total|intcomma }}</span>
        </div>
        <button id="checkoutBtn" class="checkout-btn">Proceed to Checkout</button>
        {% else %}
        <p class="empty-cart-summary">
          Add items to your cart to see the order summary.
        </p>
        {% endif %}
      </div>
    </div>

 <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Shipping Details</h2>
            <form id="shippingForm">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required><br><br>
                
                <label for="address">Address:</label>
                <textarea id="address" name="address" required></textarea><br><br>
                
                <label for="phone">Phone:</label>
                <input type="tel" id="phone" name="phone" required><br><br>
                
                <h3>Order Summary</h3>
                <div id="orderSummary"></div>
                
                <h4>Total: Ksh.<span id="totalPrice"></span></h4>
                
                <button type="submit">Confirm Order</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            const modal = $("#checkoutModal");
            const checkoutBtn = $("#checkoutBtn");
            const closeBtn = $(".close");
            const shippingForm = $("#shippingForm");
            const orderSummary = $("#orderSummary");
            const totalPriceSpan = $("#totalPrice");
            
            checkoutBtn.click(function() {
                updateOrderSummary();
                modal.css("display", "block");
            });
            
            closeBtn.click(function() {
                modal.css("display", "none");
            });
            
            $(window).click(function(event) {
                if (event.target == modal[0]) {
                    modal.css("display", "none");
                }
            });
            
            function updateOrderSummary() {
                let summary = "";
                let total = 0;
                
                $(".cart-item").each(function() {
                    const name = $(this).find(".item-name").text();
                    const quantity = $(this).find(".item-quantity span").text();
                    const price = $(this).find(".item-price").text().replace("Ksh.", "").replace(",", "");
                    const totalPrice = parseInt(price) * parseInt(quantity);
                    
                    summary += `${name} - ${quantity} x Ksh.${price} = Ksh.${totalPrice}<br>`;
                    total += totalPrice;
                });
                
                orderSummary.html(summary);
                totalPriceSpan.text(total.toLocaleString());
            }
            
            shippingForm.submit(function(e) {
                e.preventDefault();
                
                const name = $("#name").val();
                const address = $("#address").val();
                const phone = $("#phone").val();
                
                let orderDetails = `New Order:%0A%0ACustomer Details:%0AName: ${name}%0AAddress: ${address}%0APhone: ${phone}%0A%0AOrder Summary:%0A`;
                
                $(".cart-item").each(function() {
                    const itemName = $(this).find(".item-name").text();
                    const quantity = $(this).find(".item-quantity span").text();
                    const price = $(this).find(".item-price").text();
                    const totalPrice = $(this).find(".item-total").text();
                    const imageUrl = $(this).find(".item-image").attr("src");
                    
                    orderDetails += `%0AItem: ${itemName}%0AQuantity: ${quantity}%0APrice: ${price}%0ATotal: ${totalPrice}%0AImage: ${window.location.origin}${imageUrl}%0A`;
                });
                
                orderDetails += `%0ATotal Order Amount: Ksh.${totalPriceSpan.text()}`;
                
                // Replace 'PHONE_NUMBER' with the seller's actual WhatsApp number
                const whatsappUrl = `https://wa.me/PHONE_NUMBER?text=${orderDetails}`;
                
                window.open(whatsappUrl, '_blank');
                modal.css("display", "none");
            });
        });
    </script>

    <script src="{% static 'javascript/script.js' %}"></script>
  </body>
</html>
