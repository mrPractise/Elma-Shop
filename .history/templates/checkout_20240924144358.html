{% load humanize %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}" />


<div class="checkout-container">
    <h1>Checkout</h1>
    <h2>Order Number: {{ order_number }}</h2>
    <form method="post">
        {% csrf_token %}
        {{ form.name.label_tag }}
        {{ form.name }}
        
        <div id="location-selection">
            {{ form.location.label_tag }}
            {{ form.location }}
        </div>
        
        <div id="custom-address-option">
            {{ form.custom_address }} Use custom address
        </div>
        
        <div id="custom-address-field" style="display: none;">
            {{ form.address.label_tag }}
            {{ form.address }}
        </div>
        
        {% if form.errors %}
            <div class="form-errors">
                {{ form.errors }}
            </div>
        {% endif %}

        <h2>Order Summary</h2>
        {% for item in cart_items %}
            <div class="checkout-item">
                <img src="{{ item.product.get_image_url }}" alt="{{ item.product.name }}" class="checkout-item-image">
                <div class="checkout-item-details">
                    <p>{{ item.product.name }}</p>
                    <p>Quantity: {{ item.quantity }}</p>
                    <p>Price: Ksh.{{ item.product.price|intcomma }}</p>
                    <p>Total: Ksh.{{ item.total_price|intcomma }}</p>
                </div>
            </div>
        {% endfor %}
        <h3>Subtotal: Ksh.{{ subtotal|intcomma }}</h3>
        <h3 id="shipping-cost">Shipping: Ksh.0</h3>
        <h3 id="total-cost">Total: Ksh.{{ subtotal|intcomma }}</h3>
        <button type="submit">Confirm Order</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const locationSelect = document.getElementById('id_location');
    const customAddressCheckbox = document.getElementById('id_custom_address');
    const customAddressField = document.getElementById('custom-address-field');
    const shippingCostDisplay = document.getElementById('shipping-cost');
    const totalCostDisplay = document.getElementById('total-cost');
    const subtotal = {{ subtotal }};

    function updateShippingCost() {
        let shippingCost = 0;
        if (locationSelect.value) {
            const selectedOption = locationSelect.options[locationSelect.selectedIndex];
            shippingCost = parseFloat(selectedOption.getAttribute('data-shipping-cost') || 0);
        }
        shippingCostDisplay.textContent = `Shipping: Ksh.${shippingCost.toFixed(2)}`;
        totalCostDisplay.textContent = `Total: Ksh.${(subtotal + shippingCost).toFixed(2)}`;
    }

    locationSelect.addEventListener('change', updateShippingCost);

    customAddressCheckbox.addEventListener('change', function() {
        if (this.checked) {
            customAddressField.style.display = 'block';
            locationSelect.value = '';
            locationSelect.disabled = true;
        } else {
            customAddressField.style.display = 'none';
            locationSelect.disabled = false;
        }
        updateShippingCost();
    });

    updateShippingCost();
});
</script>